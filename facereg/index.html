<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button id="start-camera" style="visibility: hidden">Start Camera</button>
    <video id="video" width="100%" height="100%" autoplay></video>
    <!-- style="visibility: hidden" -->
    <button id="click-photo" style="visibility: hidden">Click Photo</button>
    <canvas
      id="canvas"
      width="320"
      height="240"
      style="visibility: hidden"
    ></canvas>

    <p id="papan"></p>
    <audio id="aud" src="" controls style="visibility: hidden">
      Your browser does not support the audio element.
    </audio>

    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script>
      const priorities = [
        "rektor",
        "wr1",
        "wr2",
        "wr3",
        "wr4",
        "nafkhan",
        "bintang",
        "aldinata",
      ];

      let stillProcessing = false;
      let last = null;
      function playAudio(audio) {
        return new Promise((res) => {
          audio.play();
          audio.onended = res;
        });
      }

      let camera_button = document.querySelector("#start-camera");
      let video = document.querySelector("#video");
      let click_button = document.querySelector("#click-photo");
      let canvas = document.querySelector("#canvas");

      camera_button.addEventListener("click", async function () {
        let streams = await navigator.mediaDevices.enumerateDevices();
        streams = streams.filter((v) => v.kind === "videoinput");
        const id = streams[streams.length - 1].deviceId;
        video.srcObject = await navigator.mediaDevices.getUserMedia({
          video: {
            deviceId: {
              exact: id,
            },
          },
        });
      });

      $("#start-camera").trigger("click");
      click_button.addEventListener("click", async function () {
        if (stillProcessing) return;
        stillProcessing = true;
        canvas
          .getContext("2d")
          .drawImage(video, 0, 0, canvas.width, canvas.height);
        // let image_data_url = canvas.toDataURL('image/png');
        // let image_base64 = image_data_url.replace(/^data:image\/png;base64,/, "");

        let blob = canvas.toBlob(async (blob) => {
          try {
            let file = new File([blob], "fileName.jpg", { type: "image/jpeg" });
            let formData = new FormData();
            formData.append("file", file);
            // console.log(formData.get("file"))
            // console.log(formData);
            url =
              "https://compre-face.nafkhanzam.com/api/v1/recognition/recognize";
            const response = await fetch(url, {
              headers: { "x-api-key": "3a375532-1c69-4159-9116-d76acbd294ca" },
              method: "POST",
              body: formData,
            });
            const data = await response.json();
            if ("result" in data) {
              try {
                console.log(data.result.map((v) => v.subjects[0]));
              } catch (error) {
                console.error(error);
              }
              const tamu = { subject: "tamu_undangan", similarity: 0 };
              let subject = { subject: "tamu_undangan", similarity: 0 };
              const results = data.result;
              const now = Date.now();
              let found = false;
              for (const res of results) {
                for (const prio of priorities) {
                  if (
                    prio === res.subjects[0].subject &&
                    last !== res.subjects[0].subject
                  ) {
                    subject = res.subjects[0];
                    found = true;
                    break;
                  }
                }
                if (found) {
                  break;
                }
              }

              let old = subject;
              if (subject.similarity < 0.95) {
                subject = tamu;
              }

              let message = `<p>HALO ${subject.subject}, ${subject.similarity}</p>
              <p>could be ${old.subject} | ${old.similarity}</p>`;
              // alert(message);
              $("#papan").empty().append(message);
              if (subject.subject !== last) {
                last = subject.subject;
                $("#aud").prop("src", `audio/${subject.subject}.mp3`);
                let aud = document.getElementById("aud");
                await playAudio(aud);
              }
            }
          } catch (error) {
            console.error(error);
          } finally {
            console.log("done");
            stillProcessing = 0;
          }
        });
      });

      // $("#aud").on("ended", function(){
      //         stillProcessing = 0;
      // });

      setInterval(function () {
        $("#click-photo").trigger("click");
      }, 2000);
    </script>
  </body>
</html>
